name: Kakaowork Lunch Vote

on:
  schedule:
# í‰ì¼ ì˜¤ì „ 8:30 KST (UTC 23:30)
- cron: '30 23 * * 1-5'


  workflow_dispatch:

jobs:
  send-lunch-vote:
    runs-on: ubuntu-latest

    steps:
      - name: Log trigger time
        run: |
          echo "ğŸš€ Workflow triggered"
          echo "UTC time: $(date -u)"
          echo "KST time: $(TZ=Asia/Seoul date)"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Restore send history cache
        uses: actions/cache@v4
        with:
          path: sent_logs
          key: lunch-vote-${{ runner.os }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytz

      - name: Send KakaoWork message (once per day)
        env:
          KAKAOWORK_WEBHOOK_URL: ${{ secrets.KAKAOWORK_WEBHOOK_URL }}
        run: |
          python << 'EOF'
          import os
          import requests
          from datetime import datetime
          import pytz
          import sys

          webhook_url = os.getenv("KAKAOWORK_WEBHOOK_URL")
          if not webhook_url:
              raise Exception("KAKAOWORK_WEBHOOK_URL is not set")

          kst = pytz.timezone("Asia/Seoul")
          now = datetime.now(kst)

          # ì£¼ë§ ë°©ì–´ (cronì´ í˜¹ì‹œë¼ë„ ì˜ëª» ëŒ ê²½ìš° ëŒ€ë¹„)
          if now.weekday() >= 5:
              print("ğŸš« Weekend detected. Skipping send.")
              sys.exit(0)

          today = now.strftime("%Y-%m-%d")
          log_dir = "sent_logs"
          os.makedirs(log_dir, exist_ok=True)

          log_file = os.path.join(log_dir, f"sent_{today}.txt")

          if os.path.exists(log_file):
              print(f"âš ï¸ Already sent today ({today}). Skipping.")
              sys.exit(0)

          payload = {
              "text": "ğŸš ë°¥ë°¥\ní•¨ì ì€ ğŸ‘ \në”°ì ì€ ğŸ‘ \nëˆŒëŸ¬ì£¼ì„¸ìš”"
          }

          res = requests.post(webhook_url, json=payload)
          print("status:", res.status_code)
          print("response:", res.text)

          if res.status_code != 200:
              raise Exception("Failed to send KakaoWork message")

          with open(log_file, "w") as f:
              f.write(now.isoformat())

          print("âœ… Message sent and logged.")
          EOF
