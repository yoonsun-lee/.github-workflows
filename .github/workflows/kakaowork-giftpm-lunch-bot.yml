name: Kakaowork Lunch Vote

on:
  # í‰ì¼ ì˜¤ì „ 10:05 (KST) â†’ UTC 01:05
  schedule:
    - cron: '5 1 * * 1-5'

  # ìˆ˜ë™ í…ŒìŠ¤íŠ¸ìš©
  workflow_dispatch:

jobs:
  send-lunch-vote:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì‹¤í–‰ ë¡œê·¸ (ì´ê²Œ ì°íˆë©´ "ìŠ¤ì¼€ì¤„ì€ ëŒì•˜ë‹¤" í™•ì •)
      - name: Log trigger time
        run: |
          echo "ğŸš€ Workflow triggered"
          echo "UTC time: $(date -u)"
          echo "KST time: $(TZ=Asia/Seoul date)"

      # 2ï¸âƒ£ ë ˆí¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ìŠ¤í¬ë¦½íŠ¸ ì“¸ ê²½ìš°)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 3ï¸âƒ£ Python ì„¸íŒ… (í•„ìš” ì—†ìœ¼ë©´ ì œê±° ê°€ëŠ¥)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 4ï¸âƒ£ ì˜ì¡´ì„± ì„¤ì¹˜ (requests ë“±)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 5ï¸âƒ£ ì¹´ì¹´ì˜¤ì›Œí¬ ë©”ì‹œì§€ ì „ì†¡
      - name: Send KakaoWork message
        env:
          KAKAOWORK_WEBHOOK_URL: ${{ secrets.KAKAOWORK_WEBHOOK_URL }}
        run: |
          python << 'EOF'
          import os
          import requests
          from datetime import datetime
          import pytz

          webhook_url = os.getenv("KAKAOWORK_WEBHOOK_URL")
          if not webhook_url:
              raise Exception("KAKAOWORK_WEBHOOK_URL is not set")

          kst = pytz.timezone("Asia/Seoul")
          now = datetime.now(kst).strftime("%Y-%m-%d %H:%M")

          payload = {
              "text": f"ğŸ± ì ì‹¬ íˆ¬í‘œ ì‹œê°„ì…ë‹ˆë‹¤!\n({now})\n\n1ï¸âƒ£ í•œì‹\n2ï¸âƒ£ ì–‘ì‹\n3ï¸âƒ£ ì¤‘ì‹\n4ï¸âƒ£ ììœ ì‹"
          }

          res = requests.post(webhook_url, json=payload)
          print("status:", res.status_code)
          print("response:", res.text)

          if res.status_code != 200:
              raise Exception("Failed to send KakaoWork message")
          EOF
